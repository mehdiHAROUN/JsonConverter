<form [formGroup]="incidentDetailsForm">
  <mat-card class="incident-details-card">
    <mat-card-title>Incident Details</mat-card-title>
    <div class="incident-details-section">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Financial Entity Code (field 2.1)</mat-label>
        <input matInput formControlName="financialEntityCode">
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Detection Date (field 2.2)</mat-label>
        <input matInput [matDatepicker]="detectionDatePicker" formControlName="detectionDate">
        <mat-datepicker-toggle matSuffix [for]="detectionDatePicker"></mat-datepicker-toggle>
        <mat-datepicker #detectionDatePicker></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Detection Time (field 2.2)</mat-label>
        <input matInput type="time" formControlName="detectionTime">
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Classification Date (field 2.3)</mat-label>
        <input matInput [matDatepicker]="classificationDatePicker" formControlName="classificationDate">
        <mat-datepicker-toggle matSuffix [for]="classificationDatePicker"></mat-datepicker-toggle>
        <mat-datepicker #classificationDatePicker></mat-datepicker>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Classification Time (field 2.3)</mat-label>
        <input matInput type="time" formControlName="classificationTime">
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Incident Description (field 2.4)</mat-label>
        <textarea matInput rows="3" formControlName="incidentDescription"></textarea>
      </mat-form-field>

      <!-- Classification Types (field 2.5 from schema) -->
      <div formArrayName="classificationTypes" class="form-section">
        <h4>Classification Types (field 2.5)</h4>
        <div *ngFor="let classificationGroup of classificationTypes.controls; let i = index" [formGroupName]="i">
          <!-- Content for each classification type will go here -->
          <p>Classification Type {{i + 1}} (Details to be implemented)</p>
          <button mat-icon-button color="warn" type="button" (click)="removeClassificationType(i)">
            <mat-icon>remove_circle</mat-icon>
          </button>
          <mat-divider *ngIf="i < classificationTypes.controls.length - 1"></mat-divider>
        </div>
        <button mat-stroked-button color="primary" type="button" (click)="addClassificationType()">
          <mat-icon>add</mat-icon> Add Classification Type
        </button>
      </div>

      <mat-checkbox formControlName="isBusinessContinuityActivated" class="full-width">
        Business Continuity Activated (field 2.6)
      </mat-checkbox>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Incident Duration (HHH:MM:SS) (field 2.7)</mat-label>
        <input matInput formControlName="incidentDuration" placeholder="e.g., 120:30:00">
        <mat-error *ngIf="incidentDetailsForm.get('incidentDuration')?.hasError('invalidIncidentDuration')">
          Invalid duration format (HHH:MM:SS).
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Incident Discovery (field 2.8)</mat-label>
        <mat-select formControlName="incidentDiscovery">
          <mat-option *ngFor="let option of incidentDiscoveryOptions" [value]="option.value">
            {{option.label}}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Competent Authority Code (field 2.9)</mat-label>
        <input matInput formControlName="competentAuthorityCode">
      </mat-form-field>

      <!-- isIctThirdPartyProviderInvolved (field 2.17) -->
      <mat-checkbox formControlName="isIctThirdPartyProviderInvolved" class="full-width">
        Is an ICT Third-Party Provider Involved? (field 2.17)
      </mat-checkbox>

      <div *ngIf="incidentDetailsForm.get('isIctThirdPartyProviderInvolved')?.value" formGroupName="ictThirdPartyProviderDetails" class="nested-form-group">
        <h4>ICT Third-Party Provider Details (field 2.17.1)</h4>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Name of ICT Third-Party Provider (field 2.17.1.1)</mat-label>
          <input matInput formControlName="ictThirdPartyProviderName">
        </mat-form-field>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Type of ICT Third-Party Provider (field 2.17.1.2)</mat-label>
          <mat-select formControlName="ictThirdPartyProviderType">
            <mat-option *ngFor="let type of ictProviderTypes" [value]="type.value">{{ type.label }}</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Country of ICT Third-Party Provider (field 2.17.1.3)</mat-label>
          <input matInput formControlName="ictThirdPartyProviderCountry">
        </mat-form-field>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>LEI of ICT Third-Party Provider (field 2.17.1.4)</mat-label>
          <input matInput formControlName="ictThirdPartyProviderLEI">
           <mat-error *ngIf="incidentDetailsForm.get('ictThirdPartyProviderDetails.ictThirdPartyProviderLEI')?.hasError('pattern')">
            Invalid LEI format.
          </mat-error>
        </mat-form-field>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>NACE Sector of ICT Third-Party Provider (field 2.17.1.5)</mat-label>
          <input matInput formControlName="ictThirdPartyProviderNACESector">
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Other Information (field 2.10)</mat-label>
        <textarea matInput rows="3" formControlName="otherInformation"></textarea>
      </mat-form-field>

      <div class="button-group">
      </div>
    </div>
  </mat-card>
</form>